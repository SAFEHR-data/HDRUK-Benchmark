# Generated by OmopViewer 0.1.0
# Be careful editing this file

server <- function(input, output, session) {
  # download raw data -----
  output$download_raw <- shiny::downloadHandler(
    filename = "results.csv",
    content = function(file) {
      write.csv(data, file = file)
    }
  )
  
   getTidyTimings <- shiny::reactive({
  #   # Start with the raw data
     res <- data
  #   
  #   pivot_columns <- input$timings_pivot
  #   if (pivot_columns != "none") {
  #     # Specify the columns for the pivot
  #     vars <- c("task", "iteration")
  #     
  #     # Perform the pivot
  #     res <- res |>
  #       tidyr::pivot_wider(
  #         names_from = iteration,  # Use 'iteration' for the new column names
  #         values_from = time_taken_secs,  # Use 'time_taken_secs' for the values
  #         values_fn = list(time_taken_secs = mean),  # Aggregate duplicate values
  #         values_fill = list(time_taken_secs = 0)  # Fill missing values with 0 (or another value)
  #       )
  #   }
  #   
  #   # Return the processed data
  #   res
   })
  # 
  output$timings_tidy <- DT::renderDT({
    DT::datatable(
      getTidyTimings(),
      options = list(scrollX = TRUE),
      rownames = FALSE
    )
  })
  
  output$timing_plot <- shiny::renderPlot({
    # Determine which time variable to plot
    time_var <- input$time_variable
    
    if (input$plot_type == "bar") {
      ggplot2::ggplot(data, ggplot2::aes(x = data[,"task"], y = data[, time_var], fill = data[,"iteration"])) +
        ggplot2::geom_bar(stat = "identity", position = "dodge") +
        ggplot2::labs(
          title = "Time Taken by Task (Bar Plot)",
          x = "Task",
          y = ifelse(time_var == "time_taken_secs", "Time Taken (Seconds)", "Time Taken (Minutes)"),
          fill = "Iteration"
        ) +
        ggplot2::theme_minimal() +
        ggplot2::theme(
          axis.text.x = ggplot2::element_text(angle = 90, hjust = 1, size = 14),  # Increase x-axis label size
          axis.title.x = ggplot2::element_text(size = 14),  # Increase x-axis title size
          axis.title.y = ggplot2::element_text(size = 14)   # Increase y-axis title size
        )
    } else {
      ggplot2::ggplot(data, ggplot2::aes(x = data[,"task"], y = data[, time_var], color = data[,"iteration"], group = data[,"iteration"])) +
        ggplot2::geom_line() +
        ggplot2::geom_point() +
        ggplot2::labs(
          title = "Time Taken by Task (Line Plot)",
          x = "Task",
          y = ifelse(time_var == "time_taken_secs", "Time Taken (Seconds)", "Time Taken (Minutes)"),
          color = "Iteration"
        ) +
        ggplot2::theme_minimal() +
        ggplot2::theme(
          axis.text.x = ggplot2::element_text(angle = 90, hjust = 1, size = 14),  # Increase x-axis label size
          axis.title.x = ggplot2::element_text(size = 14),  # Increase x-axis title size
          axis.title.y = ggplot2::element_text(size = 14)   # Increase y-axis title size
        )
    }
    
  })
}
