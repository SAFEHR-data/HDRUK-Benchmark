# Generated by OmopViewer 0.1.0
# Be careful editing this file

server <- function(input, output, session) {
  # download raw data -----
  output$download_raw <- shiny::downloadHandler(
    filename = "results.csv",
    content = function(file) {
      OmopViewer::exportSummarisedResult(data, fileName = file)
    }
  )
  shiny::observe({
    choices <- OmopViewer::getChoices(data, flatten = TRUE)
    for (k in seq_along(choices)) {
      shiny::updateSelectizeInput(
        session,
        inputId = names(choices)[k],
        choices = choices[[k]],
        selected = choices[[k]],
        server = TRUE
      )
    }
  })
  # summarise_general_benchmark -----
  ## tidy summarise_general_benchmark -----
  getTidyDataSummariseGeneralBenchmark <- shiny::reactive({
    res <- data |>
      OmopViewer::filterData("summarise_general_benchmark", input) |>
      OmopViewer::tidyData()
    
    # columns to eliminate
    colsEliminate <- colnames(res)
    colsEliminate <- colsEliminate[!colsEliminate %in% c(
      input$summarise_general_benchmark_tidy_columns, "variable_name", "variable_level",
      "estimate_name", "estimate_type", "estimate_value"
    )]
    
    # pivot
    pivot <- input$summarise_general_benchmark_tidy_pivot
    if (pivot != "none") {
      vars <- switch(pivot,
                     "estimates" = "estimate_name",
                     "estimates and variables" = c("variable_name", "variable_level", "estimate_name")
      )
      res <- res |>
        visOmopResults::pivotEstimates(pivotEstimatesBy = vars)
    }
    
    res |>
      dplyr::select(!dplyr::all_of(colsEliminate))
  })
  output$summarise_general_benchmark_tidy <- DT::renderDT({
    DT::datatable(
      getTidyDataSummariseGeneralBenchmark(),
      options = list(scrollX = TRUE),
      rownames = FALSE
    )
  })
  output$summarise_general_benchmark_tidy_download <- shiny::downloadHandler(
    filename = "tidy_summarise_general_benchmark.csv",
    content = function(file) {
      getTidyDataSummariseGeneralBenchmark() |>
        readr::write_csv(file = file)
    }
  )
  ## output summarise_general_benchmark -----
  ## output 0 -----
  createOutput0 <- shiny::reactive({
    result <- data |>
      OmopViewer::filterData("summarise_general_benchmark", input)
    OmopViewer::omopViewerTable(
      result,
      header = input$summarise_general_benchmark_gt_0_header,
      group = input$summarise_general_benchmark_gt_0_group,
      hide = input$summarise_general_benchmark_gt_0_hide
    )
  })
  output$summarise_general_benchmark_gt_0 <- gt::render_gt({
    createOutput0()
  })
  output$summarise_general_benchmark_gt_0_download <- shiny::downloadHandler(
    filename = paste0("output_gt_summarise_general_benchmark.", input$summarise_general_benchmark_gt_0_download_type),
    content = function(file) {
      obj <- createOutput0()
      gt::gtsave(data = obj, filename = file)
    }
  )
  
  
createOutput1 <- shiny::reactive({
result <- data |>
 OmopViewer::filterData("summarise_general_benchmark", input)

  
  if (input$summarise_general_benchmark_ggplot2_1_plotType == "barplot") {
    visOmopResults::barPlot(result, x = "task", y = input$summarise_general_benchmark_estimate_name,
                            facet = input$summarise_general_benchmark_ggplot2_1_facet,
                            colour = input$summarise_general_benchmark_ggplot2_1_colour) +
      ggplot2::theme(
        axis.text.x = ggplot2::element_text(angle = 90, hjust = 1, size = 10))
      
  } else if (input$summarise_general_benchmark_ggplot2_1_plotType == "line") {
    visOmopResults::scatterPlot(result, x = "task", y = input$summarise_general_benchmark_estimate_name,
                                facet = input$summarise_general_benchmark_ggplot2_1_facet,
                                colour = input$summarise_general_benchmark_ggplot2_1_colour,
                                line = TRUE, point = TRUE, ribbon = FALSE) +
      ggplot2::theme(
        axis.text.x = ggplot2::element_text(angle = 90, hjust = 1, size = 10) )
  } else {
    NULL  # Return NULL if plot type is invalid to avoid errors
  }
})


output$summarise_general_benchmark_ggplot2_1 <- shiny::renderPlot({
  createOutput1()
})
output$summarise_general_benchmark_ggplot2_1_download <- shiny::downloadHandler(
  filename = paste0("output_ggplot2_summarise_general_benchmark", ".png"),
  content = function(file) {
    obj <- createOutput1()
    ggplot2::ggsave(
      filename = file,
      plot = obj,
      width = as.numeric(input$summarise_general_benchmark_ggplot2_1_download_width),
      height = as.numeric(input$summarise_general_benchmark_ggplot2_1_download_height),
      units = input$summarise_general_benchmark_ggplot2_1_download_units,
      dpi = as.numeric(input$summarise_general_benchmark_ggplot2_1_download_dpi)
    )
  }
)

createOutput5 <- shiny::reactive({
  result <- data |>
    OmopViewer::filterData("summarise_general_benchmark", input) |>
    visOmopResults::splitAdditional() |>
    dplyr::mutate(person_n = as.numeric(.data$person_n)) |>
    visOmopResults::splitGroup() |>
    dplyr::mutate(estimate_value = as.numeric(.data$estimate_value)) |>
    visOmopResults::pivotEstimates()
  
  ggplot2::ggplot(result, 
                  ggplot2::aes(x = person_n, 
                               y = .data[[input$summarise_general_benchmark_estimate_name]], 
                               color = cdm_name)) +
    ggplot2::geom_point() +
    ggplot2::facet_wrap(~ task) +
    ggplot2::labs(
      x = "Person Count",
      y = input$summarise_general_benchmark_estimate_name,
    ) +
    ggplot2::theme_minimal() +
    ggplot2::theme(
      legend.position = "bottom",
      axis.text.x = ggplot2::element_text(angle = 90, hjust = 1, size = 10)
    )
})

output$summarise_general_benchmark_ggplot2_5 <- shiny::renderPlot({
  createOutput5()
})

output$summarise_general_benchmark_ggplot2_5_download <- shiny::downloadHandler(
  filename = function() {
    paste0("output_ggplot2_size_summarise_general_benchmark", ".png")
  },
  content = function(file) {
    ggplot2::ggsave(
      filename = file,
      plot = createOutput5(),
      width = as.numeric(input$summarise_general_benchmark_ggplot2_5_download_width),
      height = as.numeric(input$summarise_general_benchmark_ggplot2_5_download_height),
      units = input$summarise_general_benchmark_ggplot2_5_download_units,
      dpi = as.numeric(input$summarise_general_benchmark_ggplot2_5_download_dpi)
    )
  }
)

  
  # summarise_incidence_prevalence_benchmark -----
  ## tidy summarise_incidence_prevalence_benchmark -----
  getTidyDataSummariseIncidencePrevalenceBenchmark <- shiny::reactive({
    res <- data |>
      OmopViewer::filterData("summarise_incidence_prevalence_benchmark", input) |>
      OmopViewer::tidyData()
    
    # columns to eliminate
    colsEliminate <- colnames(res)
    colsEliminate <- colsEliminate[!colsEliminate %in% c(
      input$summarise_incidence_prevalence_benchmark_tidy_columns, "variable_name", "variable_level",
      "estimate_name", "estimate_type", "estimate_value"
    )]
    
    # pivot
    pivot <- input$summarise_incidence_prevalence_benchmark_tidy_pivot
    if (pivot != "none") {
      vars <- switch(pivot,
                     "estimates" = "estimate_name",
                     "estimates and variables" = c("variable_name", "variable_level", "estimate_name")
      )
      res <- res |>
        visOmopResults::pivotEstimates(pivotEstimatesBy = vars)
    }
    
    res |>
      dplyr::select(!dplyr::all_of(colsEliminate))
  })
  output$summarise_incidence_prevalence_benchmark_tidy <- DT::renderDT({
    DT::datatable(
      getTidyDataSummariseIncidencePrevalenceBenchmark(),
      options = list(scrollX = TRUE),
      rownames = FALSE
    )
  })
  output$summarise_incidence_prevalence_benchmark_tidy_download <- shiny::downloadHandler(
    filename = "tidy_summarise_incidence_prevalence_benchmark.csv",
    content = function(file) {
      getTidyDataSummariseIncidencePrevalenceBenchmark() |>
        readr::write_csv(file = file)
    }
  )
  ## output summarise_incidence_prevalence_benchmark -----
  ## output 0 -----
  createOutput0 <- shiny::reactive({
    result <- data |>
      OmopViewer::filterData("summarise_incidence_prevalence_benchmark", input)
    OmopViewer::omopViewerTable(
      result,
      header = input$summarise_incidence_prevalence_benchmark_gt_0_header,
      group = input$summarise_incidence_prevalence_benchmark_gt_0_group,
      hide = input$summarise_incidence_prevalence_benchmark_gt_0_hide
    )
  })
  output$summarise_incidence_prevalence_benchmark_gt_0 <- gt::render_gt({
    createOutput0()
  })
  output$summarise_incidence_prevalence_benchmark_gt_0_download <- shiny::downloadHandler(
    filename = paste0("output_gt_summarise_incidence_prevalence_benchmark.", input$summarise_incidence_prevalence_benchmark_gt_0_download_type),
    content = function(file) {
      obj <- createOutput0()
      gt::gtsave(data = obj, filename = file)
    }
  )
  
  createOutput3 <- shiny::reactive({
    result <- data |>
      OmopViewer::filterData("summarise_incidence_prevalence_benchmark", input)

    
    if (input$summarise_incidence_prevalence_benchmark_ggplot2_1_plotType == "barplot") {
      visOmopResults::barPlot(result, x = "task", y = input$summarise_incidence_prevalence_benchmark_estimate_name,
                              facet = input$summarise_incidence_prevalence_benchmark_ggplot2_1_facet,
                              colour = input$summarise_incidence_prevalence_benchmark_ggplot2_1_colour) +
        ggplot2::theme(
          axis.text.x = ggplot2::element_text(angle = 90, hjust = 1, size = 10))
      
    } else if (input$summarise_incidence_prevalence_benchmark_ggplot2_1_plotType == "line") {
      visOmopResults::scatterPlot(result, x = "task", y = input$summarise_incidence_prevalence_benchmark_estimate_name,
                                  facet = input$summarise_incidence_prevalence_benchmark_ggplot2_1_facet,
                                  colour = input$summarise_incidence_prevalence_benchmark_ggplot2_1_colour,
                                  line = TRUE, point = TRUE, ribbon = FALSE) +
        ggplot2::theme(
          axis.text.x = ggplot2::element_text(angle = 90, hjust = 1, size = 10) )
    } else {
      NULL  # Return NULL if plot type is invalid to avoid errors
    }
  })

  output$summarise_incidence_prevalence_benchmark_ggplot2_1 <- shiny::renderPlot({
    createOutput3()
  })
  output$summarise_incidence_prevalence_benchmark_ggplot2_1_download <- shiny::downloadHandler(
    filename = paste0("output_ggplot2_summarise_incidence_prevalence_benchmark", ".png"),
    content = function(file) {
      obj <- createOutput3()
      ggplot2::ggsave(
        filename = file,
        plot = obj,
        width = as.numeric(input$summarise_incidence_prevalence_benchmark_ggplot2_1_download_width),
        height = as.numeric(input$summarise_incidence_prevalence_benchmark_ggplot2_1_download_height),
        units = input$summarise_incidence_prevalence_benchmark_ggplot2_1_download_units,
        dpi = as.numeric(input$summarise_incidence_prevalence_benchmark_ggplot2_1_download_dpi)
      )
    }
  )
  createOutput6 <- shiny::reactive({
    result <- data |>
      OmopViewer::filterData("summarise_incidence_prevalence_benchmark", input)
    
    result <- visOmopResults::splitAdditional(result) |>
      dplyr::mutate(person_n = as.numeric(.data$person_n))|>
      visOmopResults::splitGroup()|>
      dplyr::mutate(estimate_value = as.numeric(.data$estimate_value)) |>
      visOmopResults::pivotEstimates()
    ggplot2::ggplot(result, 
                    ggplot2::aes(x = person_n, 
                                 y = .data[[input$summarise_incidence_prevalence_benchmark_estimate_name]], 
                                 color = cdm_name)) +
      ggplot2::geom_point() +
      ggplot2::facet_wrap(~ task) +
      ggplot2::labs(
        x = "Person Count",
        y = input$summarise_incidence_prevalence_benchmark_estimate_name,
      ) +
      ggplot2::theme_minimal() +
      ggplot2::theme(
        legend.position = "bottom",
        axis.text.x = ggplot2::element_text(angle = 90, hjust = 1, size = 10)
      )
  })
  output$summarise_incidence_prevalence_benchmark_ggplot2_6 <- shiny::renderPlot({
    createOutput6()
  })
  output$summarise_incidence_prevalence_benchmark_ggplot2_6_download <- shiny::downloadHandler(
    filename = paste0("output_ggplot2_size_summarise_incidence_prevalence_benchmark", ".png"),
    content = function(file) {
      obj <- createOutput6()
      ggplot2::ggsave(
        filename = file,
        plot = obj,
        width = as.numeric(input$summarise_incidence_prevalence_benchmark_ggplot2_6_download_width),
        height = as.numeric(input$summarise_incidence_prevalence_benchmark_ggplot2_6_download_height),
        units = input$summarise_incidence_prevalence_benchmark_ggplot2_6_download_units,
        dpi = as.numeric(input$summarise_incidence_prevalence_benchmark_ggplot2_6_download_dpi)
      )
    }
  )  
  # summarise_cdm_connector_benchmark -----
  ## tidy summarise_cdm_connector_benchmark -----
  getTidyDataSummariseCdmConnectorBenchmark <- shiny::reactive({
    res <- data |>
      OmopViewer::filterData("summarise_cdm_connector_benchmark", input) |>
      OmopViewer::tidyData()
    
    # columns to eliminate
    colsEliminate <- colnames(res)
    colsEliminate <- colsEliminate[!colsEliminate %in% c(
      input$summarise_cdm_connector_benchmark_tidy_columns, "variable_name", "variable_level",
      "estimate_name", "estimate_type", "estimate_value"
    )]
    
    # pivot
    pivot <- input$summarise_cdm_connector_benchmark_tidy_pivot
    if (pivot != "none") {
      vars <- switch(pivot,
                     "estimates" = "estimate_name",
                     "estimates and variables" = c("variable_name", "variable_level", "estimate_name")
      )
      res <- res |>
        visOmopResults::pivotEstimates(pivotEstimatesBy = vars)
    }
    
    res |>
      dplyr::select(!dplyr::all_of(colsEliminate))
  })
  output$summarise_cdm_connector_benchmark_tidy <- DT::renderDT({
    DT::datatable(
      getTidyDataSummariseCdmConnectorBenchmark(),
      options = list(scrollX = TRUE),
      rownames = FALSE
    )
  })
  output$summarise_cdm_connector_benchmark_tidy_download <- shiny::downloadHandler(
    filename = "tidy_summarise_cdm_connector_benchmark.csv",
    content = function(file) {
      getTidyDataSummariseCdmConnectorBenchmark() |>
        readr::write_csv(file = file)
    }
  )
  ## output summarise_cdm_connector_benchmark -----
  ## output 0 -----
  createOutput0 <- shiny::reactive({
    result <- data |>
      OmopViewer::filterData("summarise_cdm_connector_benchmark", input)
    OmopViewer::omopViewerTable(
      result,
      header = input$summarise_cdm_connector_benchmark_gt_0_header,
      group = input$summarise_cdm_connector_benchmark_gt_0_group,
      hide = input$summarise_cdm_connector_benchmark_gt_0_hide
    )
  })
  output$summarise_cdm_connector_benchmark_gt_0 <- gt::render_gt({
    createOutput0()
  })
  output$summarise_cdm_connector_benchmark_gt_0_download <- shiny::downloadHandler(
    filename = paste0("output_gt_summarise_cdm_connector_benchmark.", input$summarise_cdm_connector_benchmark_gt_0_download_type),
    content = function(file) {
      obj <- createOutput0()
      gt::gtsave(data = obj, filename = file)
    }
  )
  
  createOutput2<- shiny::reactive({
    result <- data |>
      OmopViewer::filterData("summarise_cdm_connector_benchmark", input)
    
    
    if (input$summarise_cdm_connector_benchmark_ggplot2_1_plotType == "barplot") {
      visOmopResults::barPlot(result, x = "task", y = input$summarise_cdm_connector_benchmark_estimate_name,
                              facet = input$summarise_cdm_connector_benchmark_ggplot2_1_facet,
                              colour = input$summarise_cdm_connector_benchmark_ggplot2_1_colour) +
        ggplot2::theme(
          axis.text.x = ggplot2::element_text(angle = 90, hjust = 1, size = 10))
      
    } else if (input$summarise_cdm_connector_benchmark_ggplot2_1_plotType == "line") {
      visOmopResults::scatterPlot(result, x = "task", y = input$summarise_cdm_connector_benchmark_estimate_name,
                                  facet = input$summarise_cdm_connector_benchmark_ggplot2_1_facet,
                                  colour = input$summarise_cdm_connector_benchmark_ggplot2_1_colour,
                                  line = TRUE, point = TRUE, ribbon = FALSE) +
        ggplot2::theme(
          axis.text.x = ggplot2::element_text(angle = 90, hjust = 1, size = 10) )
    } else {
      NULL  # Return NULL if plot type is invalid to avoid errors
    }
  })
  
  output$summarise_cdm_connector_benchmark_ggplot2_1 <- shiny::renderPlot({
    createOutput2()
  })
  output$summarise_cdm_connector_benchmark_ggplot2_1_download <- shiny::downloadHandler(
    filename = paste0("output_ggplot2_summarise_cdm_connector_benchmark", ".png"),
    content = function(file) {
      obj <- createOutput2()
      ggplot2::ggsave(
        filename = file,
        plot = obj,
        width = as.numeric(input$summarise_cdm_connector_benchmark_ggplot2_1_download_width),
        height = as.numeric(input$summarise_cdm_connector_benchmark_ggplot2_1_download_height),
        units = input$summarise_cdm_connector_benchmark_ggplot2_1_download_units,
        dpi = as.numeric(input$summarise_cdm_connector_benchmark_ggplot2_1_download_dpi)
      )
    }
  )
  createOutput7 <- shiny::reactive({
    result <- data |>
      OmopViewer::filterData("summarise_cdm_connector_benchmark", input)
    
    result <- visOmopResults::splitAdditional(result) |>
      dplyr::mutate(person_n = as.numeric(.data$person_n))|>
      visOmopResults::splitGroup()|>
      dplyr::mutate(estimate_value = as.numeric(.data$estimate_value)) |>
      visOmopResults::pivotEstimates()
    ggplot2::ggplot(result, 
                    ggplot2::aes(x = person_n, 
                                 y = .data[[input$summarise_cdm_connector_benchmark_estimate_name]], 
                                 color = cdm_name)) +
      ggplot2::geom_point() +
      ggplot2::facet_wrap(~ task) +
      ggplot2::labs(
        x = "Person Count",
        y = input$summarise_cdm_connector_benchmark_estimate_name,
      ) +
      ggplot2::theme_minimal() +
      ggplot2::theme(
        legend.position = "bottom",
        axis.text.x = ggplot2::element_text(angle = 90, hjust = 1, size = 10)
      )
  })
  output$summarise_cdm_connector_benchmark_ggplot2_7 <- shiny::renderPlot({
    createOutput7()
  })
  output$summarise_cdm_connector_benchmark_ggplot2_7_download <- shiny::downloadHandler(
    filename = paste0("output_ggplot2_size_cdm_connector_benchmark_benchmark", ".png"),
    content = function(file) {
      obj <- createOutput7()
      ggplot2::ggsave(
        filename = file,
        plot = obj,
        width = as.numeric(input$summarise_cdm_connector_benchmark_ggplot2_7_download_width),
        height = as.numeric(input$summarise_cdm_connector_benchmark_ggplot2_7_download_height),
        units = input$summarise_cdm_connector_ggplot2_7_download_units,
        dpi = as.numeric(input$summarise_cdm_connector_benchmark_ggplot2_77_download_dpi)
      )
    }
  )  
  
}
